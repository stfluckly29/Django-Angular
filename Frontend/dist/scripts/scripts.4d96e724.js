"use strict";var app=angular.module("inAppTranlsationApp",["ngCookies","ngResource","ngRoute","ngSanitize","ngAnimate","webStorageModule","ngModal","underscore","mgcrea.ngStrap.tooltip","mgcrea.ngStrap.popover","angularFileUpload","filereader","mgcrea.ngStrap.alert","lr.upload"]).config(["$routeProvider","$httpProvider",function(a,b){b.interceptors.push("authcheck"),a.when("/apps/:id/edit",{templateUrl:"views/appedit.html",controller:"AppeditCtrl"}).when("/apps/:id/view",{templateUrl:"views/appview.html",controller:"AppviewCtrl"}).when("/apps",{templateUrl:"views/apps.html",controller:"AppsCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).when("/signup",{templateUrl:"views/signup.html",controller:"SignupCtrl"}).when("/profile",{templateUrl:"views/profile.html",controller:"ProfileCtrl"}).when("/logout",{templateUrl:"views/logout.html",controller:"LogoutCtrl"}).when("/stats",{templateUrl:"views/stats.html",controller:"StatsCtrl"}).otherwise({redirectTo:"/apps"})}]);app.run(["$rootScope","$location","api","_","authorization","user","webStorage",function(a,b,c,d,e,f,g){c.init(),a._=d,a.$on("$locationChangeStart",function(){var c=b.path().replace("/","");a.current_path=c,a.authenticated?("login"==c&&b.path("/"),a.isSuper||f.query({},function(b){var c=b[0].is_superuser?"Y":"N";g.add("isSuper",c),a.isSuper=c})):"login"!=c&&"signup"!=c&&b.path("/login")}),a.showPopup=!1,a.popup={name:"",email:"",message:""},a.togglePopup=function(){a.showPopup=!a.showPopup,console.log(a.showPopup)},a.popupSubmit=function(){var b=a.popup,c=/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;b.name&&b.email&&b.message&&c.test(b.email)?(a.popupInvalid=!1,e.sendMessage(b),a.msgSent=!0):a.popupInvalid=!0}}]),angular.module("inAppTranlsationApp").factory("api",["$http","webStorage","$rootScope",function(a,b,c){return{init:function(d){var e=d||b.get("token");e&&(e="Token "+e,a.defaults.headers.common.Authorization=e,c.authenticated=!0,c.username=b.get("username"),c.isSuper=b.get("isSuper"))},destroy:function(){delete a.defaults.headers.common.Authorization,b.clear(),c.authenticated=!1,c.username="",c.isSuper=""}}}]),angular.module("inAppTranlsationApp").controller("LoginCtrl",["$scope","$location","webStorage","authorization","api","$rootScope","$http","config",function(a,b,c,d,e,f,g,h){f.fromRegister&&(a.error_msg="Please verify your email address to login.",delete f.fromRegister),a.login=function(){a.error_msg="";var f={username:this.username,password:this.password};console.log(this.remember),this.remember?c.order(["local","session","memory"]):c.order(["session","memory","local"]);var g=function(d){console.log(d);var f=d.token;c.add("token",f),c.add("username",a.username),c.local.add("remember",a.remember),e.init(f),b.path("/apps")},h=function(b){var c="";for(var d in b)c+=b[d];a.error_msg=c};d.login(f).success(g).error(h)},a.forgot_password=function(){window.alertify.prompt("Please enter your email address.",function(a,b){var c=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;if(c.test(b)){var d=h.api_url+"/users/forget_password";f.loading=!0,g.post(d,{email:b}).success(function(){window.alertify.success("You'll get reset request email shortly."),f.loading=!1}).error(function(a){f.loading=!1;var b="";for(var c in a)b+=a[c];window.alertify.error(b)})}else window.alertify.error("Please input valid email address")})}}]);var config=config||{};config.development={api_url:"http://ec2-54-65-53-178.ap-northeast-1.compute.amazonaws.com/api"},config.staging={api_url:"//ec2-54-65-53-178.ap-northeast-1.compute.amazonaws.com/api"},config.production={api_url:"//inapptranslation.com/api"},angular.module("inAppTranlsationApp").factory("config",function(){var a=function(){var a=window.document.URL;return-1!==a.indexOf("//127.0.0.1")||-1!==a.indexOf("//localhost")?"development":-1!==a.indexOf("//ec2-54-65-53-178.ap-northeast-1.compute.amazonaws.com")?"staging":-1!==a.indexOf("inapptranslation.com")?"production":void 0}();if(!a)throw new Error("failed to detect application env");return window.config[a]}),angular.module("inAppTranlsationApp").factory("authorization",["$http","config","api",function(a,b,c){var d=b.api_url;return{login:function(b){return a.post(d+"/api-token-auth",b)},sendMessage:function(b){return a.post(d+"/send-message",b)},logout:function(){c.destroy()}}}]),angular.module("inAppTranlsationApp").controller("AppsCtrl",["$scope","App","_",function(a,b,c){a.apps=b.query(),a.appRegShown=!1,a.toggleModal=function(){a.appRegShown=!a.appRegShown},a.registerApp=function(){b.save({name:this.app_name},function(b){a.apps.push(b)}),a.appRegShown=!a.appRegShown,a.app_name=""}}]),angular.module("inAppTranlsationApp").controller("ProfileCtrl",["$scope","user",function(a,b){b.query({},function(b){a.user=b[0]}),a.submitForm=function(b){if(a.success=!1,a.error_msg="",b){if(a.user.password!=a.user.password1)return void window.alertify.error("Password doesn't match.");a.user.$update(function(){a.success=!0},function(b){var c="";for(var d in b)c+=b[d];a.error_msg=c})}}}]),angular.module("inAppTranlsationApp").controller("LogoutCtrl",["$location","authorization",function(a,b){console.log("LogoutCtrl"),b.logout(),a.path("/login")}]),angular.module("inAppTranlsationApp").factory("App",["$resource","config",function(a,b){var c=b.api_url+"/apps/:id:custom";return a(c,{id:"@id",custom:"@custom"},{update:{method:"PUT"},localwords:{methods:"GET",is_array:!1}})}]),angular.module("inAppTranlsationApp").controller("AppeditCtrl",["$scope","$routeParams","App","$timeout","webStorage","upload","config","$rootScope","$http","$location",function(a,b,c,d,e,f,g,h,i,j){a.token=e.get("token"),a.show_cert_upload=!1,a.prod_cert=!1,a.dev_cert=!1,a.api_url=g.api_url,c.get({id:b.id},function(b){a.app=b;for(var c in b.certs)b.certs[c].cert_type?a.prod_cert=b.certs[c]:a.dev_cert=b.certs[c]}),a.save=function(b){a.success=!1,c.update(b,function(){a.success=!0,d(function(){a.success=!1},3e3)})},a.show_upload=function(b){a.cert_pwd="",a.cert_type=b,a.show_cert_upload=!0},a.upload=function(c,d){if(c.length){var e=c[0].name,i=".p12";if(-1===e.indexOf(i,e.length-i.length))return void window.alertify.alert("Please select p12 file.");f({url:g.api_url+"/apps/"+b.id+"/add_cert",method:"POST",data:{cert_file:c[0],cert_type:a.cert_type,password:d}}).then(function(b){a.show_cert_upload=!1,h.loading=!1;var c=b.data.cert;c.cert_type?a.prod_cert=c:a.dev_cert=c,window.alertify.success("Successfully added a certificate.")},function(b){console.log(b),a.show_cert_upload=!1,h.loading=!1,window.alertify.error(b.data.errors)}),h.loading=!0}},a.delete_cert=function(c){i["delete"](g.api_url+"/apps/"+b.id+"/remove_"+c+"_cert").then(function(){a[c+"_cert"]=!1,h.loading=!1,window.alertify.success("Successfully removed a certificate.")},function(a){window.alertify.error(a.data.errors),h.loading=!1}),h.loading=!0},a.deleteApp=function(a){window.alertify.confirm("Do you really want to delete this app?",function(b){b&&(h.loading=!0,i["delete"](g.api_url+"/apps/"+a).then(function(){h.loading=!1,j.path("/apps")},function(a){window.alertify.error(a.data.errors),h.loading=!1}))})}}]),angular.module("inAppTranlsationApp").controller("AppviewCtrl",["$scope","$routeParams","App","_","$http","config","Translation","Word","FileReader","$rootScope",function(a,b,c,d,e,f,g,h,i,j){function k(){return{width:370*(a.data.langs.length+1)+150+"px"}}function l(){var b=[];for(var c in a.data.langs)b.push(a.data.langs[c]);var e=d.difference(d.keys(window.langData),b),f=[];for(var c in e)f.push({val:e[c],caption:window.langData[e[c]]});return f}a.size_options=[{value:20,text:20},{value:40,text:40},{value:60,text:60},{value:80,text:80},{value:100,text:100}],a.scrollTop=0,j.loading=!0,a.import_step1=!1,a.push_popup=!1,a.app=c.get({id:b.id}),a.new_word="",c.localwords({id:b.id,custom:"/localwords"}).$promise.then(function(b){a.data=b,a.row_width=k(),a.avail_langs=l(),j.loading=!1,a.$broadcast("dataloaded")}),a.langData=window.langData,a.addLang=function(b){a.data.langs.push(b),a.row_width=k(),a.avail_langs=d.reject(a.avail_langs,function(a){return b==a.val})},a.removeLang=function(b){window.alertify.confirm("Do you really want to delete this Language?",function(c){if(c){var d=a.data.langs[b];a.data.langs.splice(b,1),a.row_width=k(),a.avail_langs=l();var g=f.api_url+"/apps/"+a.app.id+"/lang?code="+d;e["delete"](g)}})},a.updateKey=function(a){var b=f.api_url+"/words/"+a.word.id;e.put(b,{id:a.word.id,app:a.word.app,name:a.updated_key}).success(function(){a.word.name=a.updated_key,a.$hide()})},a.deleteKey=function(b){var c=f.api_url+"/words/"+b.word.id;e["delete"](c).success(function(){a.reload()})},a.addTranslation=function(b){g.save({name:b.local_word,lang:b.lang,word:b.word.id,app:a.app.id},function(c){a.data.translations[c.word]||(a.data.translations[c.word]={}),a.data.translations[c.word][b.lang]||(a.data.translations[c.word][b.lang]={}),a.data.translations[c.word][b.lang]=c})},a.selectTranslation=function(b,c){if(!c.selected){c.selected=!0,g.update(c);for(var d in a.data.translations[b.word.id][b.lang])a.data.translations[b.word.id][b.lang][d].id!=c.id&&(a.data.translations[b.word.id][b.lang][d].selected=!1)}},a.removeTranslation=function(b,c,d){window.alertify.confirm("Do you really remove this translation?",function(e){e&&(g["delete"]({id:c.id},function(c){if(-1!=c.id)for(var d in a.data.translations[b.word.id][b.lang])a.data.translations[b.word.id][b.lang][d].id==c.id&&(a.data.translations[b.word.id][b.lang][d].selected=!0)}),a.data.translations[b.word.id][b.lang].splice(d,1))})},a.addWord=function(b,c){j.loading=!0,h.save({app:a.app.id,name:b.new_word},function(d){a.data.words.unshift(d),a.data.end_index++,c&&b.$hide(),b.new_word="",j.loading=!1},function(a){400==a.status&&(j.loading=!1,b.new_word="",window.alertify.error("Duplicated word"))})},a._geExportValue=function(a){var b=a.replace(/\\/g,"\\\\");return b=b.replace(/'/g,"\\'"),b=b.replace(/"/g,'\\"'),b=b.replace(/%@/g,"%s"),b=b.replace(/\$@/g,"$s"),b=b.replace("&","&amp;"),b=b.replace(">","&gt;"),b=b.replace("<","&lt;")},a["export"]=function(c){j.loading=!0,a.show_export=!1;var g=new window.JSZip,h=f.api_url+"/apps/"+b.id+"/web_translations";e.get(h,{}).success(function(b){var e=b.translations;if(!e.length)return j.loading=!1,void window.alertify.alert("You don't have translation data to export yet.");var f=e.length;"android"==c&&(f+=1);var h=d.after(f,function(){var b="";window.bowser.safari?(window.alertify.alert('In Safari, eported file will be named as "Unkown" (without zip extension). But this is a zip file. Please double click this "Unknown" file to unzip the file'),b=g.generate(),window.location.href="data:application/zip;base64,"+b):(b=g.generate({type:"blob"}),window.saveAs(b,a.app.name+".zip")),j.loading=!1}),i=[];if(d.each(e,function(b){if("ios"==c){var e=g.folder(b.lang+".lproj"),f="/*\n";f+="Localizable.strings\n",f+=window.langData[b.lang]+" words for '"+a.app.name+"'\n",f+="Created by InAppTranslation on "+(new Date).toString("M/d/yyyy")+"\n",f+="*/\n\n\n";for(var j in b.content){var k=b.content[j].translation,l=b.content[j].word.replace(/"/g,'\\"'),m=k.replace(/\\/g,"\\\\");m=m.replace(/"/g,'\\"'),f+='"'+l+'" = "'+m+'";\n'}e.file("Localizable.strings",window.Base64.encode(f),{base64:!0})}else{var n=b.lang;"zh-Hans"==n&&(n="zh-CN"),"zh-Hant"==n&&(n="zh-TW");var o=n.split("-");o.length>1&&(o[1]="r"+o[1]);var p="values";for(var q in o)p+="-"+o[q];var e=g.folder(p),f='<?xml version="1.0" encoding="utf-8"?>';f+="<!--\n",f+="Localizable.strings\n",f+=window.langData[b.lang]+" words for '"+a.app.name+"'\n",f+="Created by InAppTranslation on "+(new Date).toString("M/d/yyyy")+"\n",f+="-->\n\n",f+="<resources>\n";var r=[];for(var j in b.content){var k=b.content[j].translation,s=b.content[j].word,l=s.replace(/"/gim,"");if(l=l.replace(/'/g,""),l=l.replace(/[\.\-/ ]/gim,"_"),l=l.replace(/[^a-z0-9_]/gim,"x"),"0"<=l[0]&&l[0]<="9"&&(l="_"+l),l=l.substring(0,Math.min(100,l.length)),d.findWhere(r,{key:l,val:k}))for(var t=l.substring(0,Math.min(99,l.length)),u=1;d.findWhere(r,{key:t+u,val:k});)u+=1;else r.push({key:l,val:k});d.findWhere(i,{key:l})||i.push({key:l,val:a._geExportValue(s)});var m=a._geExportValue(k),v=(m.match(/%/gim)||[]).length;f+='	<string name="'+l+'"'+(v>1?' formatted="false"':"")+">"+m+"</string>\n"}f+="</resources>",e.file("strings.xml",window.Base64.encode(f),{base64:!0})}h()}),"android"==c){var k=g.folder("values"),l='<?xml version="1.0" encoding="utf-8"?>';l+="<!--\n",l+="Localizable.strings\n",l+="Base words for '"+a.app.name+"'\n",l+="Created by InAppTranslation on "+(new Date).toString("M/d/yyyy")+"\n",l+="-->\n\n",l+="<resources>\n";for(var m in i){var n=i[m].key,o=i[m].val,p=(o.match(/%/gim)||[]).length;l+='	<string name="'+n+'"'+(p>1?' formatted="false"':"")+">"+o+"</string>\n"}l+="</resources>",k.file("strings.xml",window.Base64.encode(l),{base64:!0}),h()}}).error(function(a){window.alertify.error(a.errors),j.loading=!1})},a.import_next=function(){this.import_lang?(a.selected_lang=this.import_lang,a.import_step1=!1,a.import_step2=!0):window.alertify.alert("Please select a language.")},a.upload=function(c){i.readAsText(c[0],"utf-8",a).then(function(c){function d(){if(null!==n){for(var c=f.api_url+"/translations/import_localwords",d=[],g=[],h=0;h<n.length;h++)for(var o in n[h])-1===g.indexOf(o)?(d.push({word:o,val:n[h][o]}),g.push(o)):(i-=1,console.log(o));var p={data:d};p.app=b.id,p.lang=a.selected_lang,p.pz=a.data.page_size,j.loading=!0,a.import_step2=!1,e.post(c,p).success(function(b){a.data=b,a.avail_langs=l(),a.row_width=k(),j.loading=!1,i>0&&window.alertify.success(i+" translation"+(i>1?"s":"")+" are imported."),m>0&&window.alertify.error(m+" translation"+(m>1?"s":"")+" are failed")}).error(function(){j.loading=!1,window.alertify.error("There was an error while process import on server side.")})}}var g=c;g=g.trim(),g=g.replace(/^\s*\/\/.+$/gm,""),g=g.replace(/\/\*(.|\n)*?\*\//g,""),g=g.replace("\\“",'\\"'),g=g.replace("\\”",'\\"');for(var h=g.split('";'),i=0,m=0,n=[],o=[],p=0;p<h.length;p++)if(h[p]&&h[p].length>0){var q=h[p];if(q=q.replace(/^\s*\/\/.+$/gm,""),q=q.trim(),!q)continue;q=q.replace(/"\s=\s"/g,'":"'),q=q.replace(/;/g,""),q="{"+q+'"}';try{var r=window.jQuery.parseJSON(q);i+=1,n.push(r)}catch(s){o.push(h[p]+'";'),m+=1}}m>0?(alertify.set({labels:{ok:"See Errors",cancel:"Continue"}}),window.alertify.confirm("We found "+m+" invalid translation"+(m>1?"s":"")+". Would you like continue or see invalid translations?",function(a){alertify.set({labels:{ok:"OK",cancel:"Cancel"}}),a?(console.log(o),window.alertify.alert("Invalid translations...<br>"+o.join("<br>"))):d()})):d()})},a.send_push=function(b){var c=f.api_url+"/apps/"+a.app.id+"/send_push?type="+b;j.loading=!0,e.get(c,{}).success(function(b){a.push_popup=!1,j.loading=!1,window.alertify.success("Sending push notification is being done on server side.")}).error(function(b){a.push_popup=!1,window.alertify.error(b.errors),j.loading=!1})},a.load_next_page=function(){a.data.page++,a.reload()},a.load_prev_page=function(){a.data.page--,a.reload()},a.reload=function(){var c=f.api_url+"/apps/"+b.id+"/localwords?p="+a.data.page+"&pz="+a.data.page_size;j.loading=!0,e.get(c).success(function(b){a.data=b,a.row_width=k(),a.avail_langs=l(),j.loading=!1,a.$broadcast("dataloaded")})}}]),angular.module("inAppTranlsationApp").service("Translation",["$resource","config",function(a,b){var c=b.api_url+"/translations/:id";return a(c,{id:"@id"},{update:{method:"PUT"}})}]),angular.module("inAppTranlsationApp").directive("focusMe",function(){return{scope:{trigger:"=focusMe"},link:function(a,b){a.$watch("trigger",function(c){c===!0&&(b[0].focus(),a.trigger=!1)})}}}),app.directive("autofocus",["$timeout",function(a){return{restrict:"A",link:function(b,c){a(function(){c[0].focus()},50)}}}]),angular.module("inAppTranlsationApp").service("Word",["$resource","config",function(a,b){var c=b.api_url+"/words/:id";return a(c,{id:"@id"},{})}]),angular.module("inAppTranlsationApp").directive("resizable",["$window",function(a){return function(b){return b.initializeWindowSize=function(){b.windowHeight=a.innerHeight,b.windowWidth=a.innerWidth},b.initializeWindowSize(),angular.element(a).bind("resize",function(){return b.initializeWindowSize(),b.$apply()})}}]),angular.module("inAppTranlsationApp").service("authcheck",["$q","$injector",function(a,b){var c={responseError:function(c){if(console.log("Failed with",c.status,"status"),401===c.status||403===c.status){var d=b.get("api"),e=b.get("$location");d.destroy(),e.url("/login")}return a.reject(c)}};return c}]),angular.module("inAppTranlsationApp").controller("SignupCtrl",["$scope","user","$location","$rootScope",function(a,b,c,d){a.pw_input_type="password",a.signup=function(){a.error_msg="",d.loading=!0,b.save(this.user,function(){d.loading=!1,d.fromRegister=!0,c.path("/login")},function(b){d.loading=!1,b=b.data;var c="";for(var e in b)c+=b[e][0];c=c.replace("Username","email"),a.error_msg=c})},a.tick_pw_type=function(){"password"==a.pw_input_type?a.pw_input_type="text":a.pw_input_type="password"}}]),angular.module("inAppTranlsationApp").controller("StatsCtrl",["$scope","user",function(a,b){b.query({id:"stats"},function(b){a.stats=b[0]})}]),angular.module("inAppTranlsationApp").service("user",["$resource","config",function(a,b){var c=b.api_url+"/users/:id";return a(c,{id:"@id"},{update:{method:"PUT"}})}]);var langData={ar:"Arabic",ca:"Catalan","zh-Hans":"Chinese(Simplified)","zh-Hant":"Chinese(Traditional)",hr:"Croatian",cs:"Czech",nl:"Dutch",da:"Danish",en:"English","en-GB":"English (British)","en-AU":"English (Australian)",fi:"Finnish",fr:"French",de:"German",el:"Greek",he:"Hebrew",hu:"Hungarian",id:"Indonesian",it:"Italian",ja:"Japanese",ko:"Korean","es-MX":"Mexican Spanish",ms:"Malay",nb:"Norwegian (Bokmal)",pl:"Polish",pt:"Portuguese","pt-PT":"Portuguese (Portugal)",ro:"Romanian",ru:"Russian",sk:"Slovak",es:"Spanish",sv:"Swedish",th:"Thai",tr:"Turkish",uk:"Ukrainian",vi:"Vietnamese"};angular.module("inAppTranlsationApp").directive("scrollFix",function(){return{restrict:"A",link:function(a,b){var c=$("#top-link-wrapper"),d=$("#dummy-box"),e=$(".row.header");b.bind("scroll",function(){var a=$(b).find(".fixed, .popover.small.key-modal"),f=b.scrollLeft(),g=b.scrollTop();f>0?d.addClass("under"):d.removeClass("under"),e.css("top",g),c.css("top",g),a.css("left",f),c.css("left",f),d.css("left",f)})}}}),angular.module("inAppTranlsationApp").directive("fixedHeader",["$timeout",function(a){return{link:function(b,c,d){b.$on("dataloaded",function(){var d=($(".language_table"),!1);b.$watch("windowHeight",function(){d&&c.fixedHeaderTable({height:b.windowHeight-260})}),b.$watch("windowWidth",function(){d&&(c.fixedHeaderTable("destroy"),c.fixedHeaderTable({fixedColumn:!0}))}),b.$watch("avail_langs",function(){d&&a(function(){c.fixedHeaderTable("destroy"),c.fixedHeaderTable({fixedColumn:!0})})}),a(function(){c.fixedHeaderTable({fixedColumn:!0}),d=!0},0,!1)})}}}]);